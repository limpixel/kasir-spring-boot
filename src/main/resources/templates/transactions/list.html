<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Transaksi - Inventory Management</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div layout:fragment="content">
        <!-- Alert Messages -->
        <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${message}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- Header Actions -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="text-gray-800">Manajemen Transaksi</h4>
                <small class="text-muted">Kelola riwayat transaksi penjualan dan pembelian</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-success" onclick="showSaleModal()">
                    <i class="bi bi-cash-coin me-2"></i>+ Sale
                </button>
                <button class="btn btn-info" onclick="showPurchaseModal()">
                    <i class="bi bi-cart-plus me-2"></i>+ Purchase
                </button>
                <button class="btn btn-warning" onclick="refreshTable()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                </button>
                <button class="btn btn-primary" onclick="generateReport()">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Laporan
                </button>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="stat-card stat-success">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-uppercase text-secondary small mb-1">Total Penjualan</div>
                            <div class="h5 mb-0 font-weight-bold" id="totalSales">Rp 0</div>
                        </div>
                        <div class="text-success">
                            <i class="bi bi-graph-up fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="stat-card stat-info">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-uppercase text-secondary small mb-1">Total Pembelian</div>
                            <div class="h5 mb-0 font-weight-bold" id="totalPurchases">Rp 0</div>
                        </div>
                        <div class="text-info">
                            <i class="bi bi-graph-down fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="stat-card stat-primary">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-uppercase text-secondary small mb-1">Total Transaksi</div>
                            <div class="h5 mb-0 font-weight-bold" id="totalTransactions">0</div>
                        </div>
                        <div class="text-primary">
                            <i class="bi bi-receipt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="stat-card stat-warning">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-uppercase text-secondary small mb-1">Net Revenue</div>
                            <div class="h5 mb-0 font-weight-bold" id="netRevenue">Rp 0</div>
                        </div>
                        <div class="text-warning">
                            <i class="bi bi-wallet2 fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Search and Filter -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Cari transaksi..." onkeyup="searchTransactions()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="typeFilter" onchange="filterTransactions()">
                            <option value="">Semua Tipe</option>
                            <option value="SALE">Sale</option>
                            <option value="PURCHASE">Purchase</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="startDate" onchange="filterTransactions()">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="endDate" onchange="filterTransactions()">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Transactions Table -->
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="m-0 font-weight-bold">Riwayat Transaksi</h6>
                    <small class="text-muted" id="totalRecords">Memuat data...</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="changeView('table')">
                        <i class="bi bi-table"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="changeView('chart')">
                        <i class="bi bi-graph-up"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Table View -->
                <div id="tableView">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Tanggal</th>
                                    <th>Produk</th>
                                    <th>Tipe</th>
                                    <th>Quantity</th>
                                    <th>Total Harga</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2">Memuat data transaksi...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Chart View -->
                <div id="chartView" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-center">Grafik Penjualan vs Pembelian</h6>
                            <canvas id="transactionChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-center">Distribusi Tipe Transaksi</h6>
                            <canvas id="typeChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Pagination -->
                <nav class="mt-3" id="paginationContainer">
                    <!-- Pagination will be dynamically inserted here -->
                </nav>
            </div>
        </div>
        
        <!-- Sale Modal -->
        <div class="modal fade" id="saleModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-cash-coin me-2"></i>Buat Sale
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="saleForm">
                            <div class="mb-3">
                                <label for="saleProduct" class="form-label">Pilih Produk *</label>
                                <select class="form-select" id="saleProduct" required onchange="updateSaleProductInfo()">
                                    <option value="">-- Pilih Produk --</option>
                                </select>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Stok Tersedia</label>
                                    <input type="text" class="form-control" id="availableStock" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="saleQuantity" class="form-label">Quantity *</label>
                                    <input type="number" class="form-control" id="saleQuantity" min="1" required oninput="calculateSaleTotal()">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Total Harga</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="text" class="form-control" id="saleTotal" readonly>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="saleDescription" class="form-label">Deskripsi</label>
                                <textarea class="form-control" id="saleDescription" rows="3" placeholder="Catatan transaksi..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-success" onclick="createSale()">
                            <i class="bi bi-check-circle me-2"></i>Proses Sale
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Purchase Modal -->
        <div class="modal fade" id="purchaseModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-cart-plus me-2"></i>Buat Purchase
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="purchaseForm">
                            <div class="mb-3">
                                <label for="purchaseProduct" class="form-label">Pilih Produk *</label>
                                <select class="form-select" id="purchaseProduct" required onchange="updatePurchaseProductInfo()">
                                    <option value="">-- Pilih Produk --</option>
                                </select>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Stok Saat Ini</label>
                                    <input type="text" class="form-control" id="currentStock" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="purchaseQuantity" class="form-label">Quantity *</label>
                                    <input type="number" class="form-control" id="purchaseQuantity" min="1" required oninput="calculatePurchaseTotal()">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Total Harga</label>
                                <div class="input-group">
                                    <span class="input-group-text">Rp</span>
                                    <input type="text" class="form-control" id="purchaseTotal" readonly>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="purchaseDescription" class="form-label">Deskripsi</label>
                                <textarea class="form-control" id="purchaseDescription" rows="3" placeholder="Catatan transaksi..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-info" onclick="createPurchase()">
                            <i class="bi bi-check-circle me-2"></i>Proses Purchase
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Transaction Management JavaScript
        let allTransactions = [];
        let filteredTransactions = [];
        let allProducts = [];
        let currentPage = 0;
        const pageSize = 10;
        let transactionChart = null;
        let typeChart = null;
        
        // Load initial data
        async function loadInitialData() {
            try {
                showLoading();
                await Promise.all([
                    loadTransactions(),
                    loadProducts(),
                    loadStatistics()
                ]);
                hideLoading();
            } catch (error) {
                console.error('Error loading initial data:', error);
                hideLoading();
                showAlert('Gagal memuat data awal', 'danger');
            }
        }
        
        // Load transactions
        async function loadTransactions() {
            try {
                const response = await fetch('/api/transactions', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load transactions');
                }
                
                allTransactions = await response.json();
                filteredTransactions = [...allTransactions];
                displayTransactions();
                updateTotalRecords();
            } catch (error) {
                console.error('Error loading transactions:', error);
                showAlert('Gagal memuat data transaksi', 'danger');
            }
        }
        
        // Load products
        async function loadProducts() {
            try {
                const response = await fetch('/api/products', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load products');
                }
                
                allProducts = await response.json();
                populateProductSelects();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        // Load statistics
        async function loadStatistics() {
            try {
                const [salesRes, purchasesRes, revenueRes] = await Promise.all([
                    fetch('/api/transactions/stats/total-sales', { headers: getAuthHeaders() }),
                    fetch('/api/transactions/stats/total-purchases', { headers: getAuthHeaders() }),
                    fetch('/api/transactions/stats/net-revenue', { headers: getAuthHeaders() })
                ]);
                
                const totalSales = await salesRes.text();
                const totalPurchases = await purchasesRes.text();
                const netRevenue = await revenueRes.text();
                
                document.getElementById('totalSales').textContent = formatCurrency(totalSales || 0);
                document.getElementById('totalPurchases').textContent = formatCurrency(totalPurchases || 0);
                document.getElementById('netRevenue').textContent = formatCurrency(netRevenue || 0);
                document.getElementById('totalTransactions').textContent = allTransactions.length;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }
        
        // Display transactions in table
        function displayTransactions() {
            const tbody = document.getElementById('transactionsTableBody');
            const start = currentPage * pageSize;
            const end = start + pageSize;
            const pageData = filteredTransactions.slice(start, end);
            
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fa-3x mb-3"></i>
                            <div>Tidak ada data transaksi</div>
                            <button class="btn btn-success btn-sm mt-2" onclick="showSaleModal()">
                                <i class="bi bi-plus-circle me-1"></i>Buat Transaksi Pertama
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pageData.map(transaction => `
                <tr>
                    <td><span class="badge bg-secondary">#${transaction.id}</span></td>
                    <td>${formatDate(transaction.createdAt)}</td>
                    <td>
                        <strong>${transaction.product.name}</strong>
                    </td>
                    <td>
                        <span class="badge ${transaction.transactionType === 'SALE' ? 'bg-success' : 'bg-info'}">
                            ${transaction.transactionType}
                        </span>
                    </td>
                    <td>${transaction.quantity}</td>
                    <td>Rp ${transaction.totalPrice.toLocaleString('id-ID')}</td>
                    <td>
                        <span class="badge ${getTransactionStatusClass(transaction)}">
                            ${getTransactionStatus(transaction)}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewTransaction(${transaction.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${transaction.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            updatePagination();
        }
        
        // Get transaction status class
        function getTransactionStatusClass(transaction) {
            if (transaction.transactionType === 'SALE') {
                return 'bg-success';
            } else {
                return 'bg-info';
            }
        }
        
        // Get transaction status
        function getTransactionStatus(transaction) {
            return transaction.transactionType;
        }
        
        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredTransactions.length / pageSize);
            const container = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let pagination = '<nav><ul class="pagination justify-content-center">';
            
            // Previous button
            pagination += `
                <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                if (i === 0 || i === totalPages - 1 || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    pagination += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i + 1}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    pagination += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            // Next button
            pagination += `
                <li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;
            
            pagination += '</ul></nav>';
            container.innerHTML = pagination;
        }
        
        // Update total records
        function updateTotalRecords() {
            document.getElementById('totalRecords').textContent = 
                `Menampilkan ${filteredTransactions.length} dari ${allTransactions.length} transaksi`;
        }
        
        // Search transactions
        function searchTransactions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredTransactions = allTransactions.filter(transaction => 
                transaction.product.name.toLowerCase().includes(searchTerm) ||
                transaction.transactionType.toLowerCase().includes(searchTerm) ||
                transaction.id.toString().includes(searchTerm)
            );
            currentPage = 0;
            displayTransactions();
            updateTotalRecords();
        }
        
        // Filter transactions
        function filterTransactions() {
            const typeFilter = document.getElementById('typeFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            filteredTransactions = allTransactions.filter(transaction => {
                let matchesType = !typeFilter || transaction.transactionType === typeFilter;
                
                let matchesDate = true;
                if (startDate) {
                    matchesDate = matchesDate && new Date(transaction.createdAt) >= new Date(startDate);
                }
                if (endDate) {
                    matchesDate = matchesDate && new Date(transaction.createdAt) <= new Date(endDate + 'T23:59:59');
                }
                
                return matchesType && matchesDate;
            });
            
            currentPage = 0;
            displayTransactions();
            updateTotalRecords();
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            filteredTransactions = [...allTransactions];
            currentPage = 0;
            displayTransactions();
            updateTotalRecords();
        }
        
        // Populate product selects
        function populateProductSelects() {
            const saleSelect = document.getElementById('saleProduct');
            const purchaseSelect = document.getElementById('purchaseProduct');
            
            const productOptions = '<option value="">-- Pilih Produk --</option>' + 
                allProducts.map(product => 
                    `<option value="${product.id}" data-price="${product.price}" data-stock="${product.stock}">
                        ${product.name} (Stok: ${product.stock})
                    </option>`
                ).join('');
            
            saleSelect.innerHTML = productOptions;
            purchaseSelect.innerHTML = productOptions;
        }
        
        // Show sale modal
        function showSaleModal() {
            new bootstrap.Modal(document.getElementById('saleModal')).show();
        }
        
        // Show purchase modal
        function showPurchaseModal() {
            new bootstrap.Modal(document.getElementById('purchaseModal')).show();
        }
        
        // Update sale product info
        function updateSaleProductInfo() {
            const select = document.getElementById('saleProduct');
            const selectedOption = select.options[select.selectedIndex];
            const stock = selectedOption.getAttribute('data-stock');
            
            document.getElementById('availableStock').value = stock || '0';
            document.getElementById('saleQuantity').max = stock || '0';
            calculateSaleTotal();
        }
        
        // Update purchase product info
        function updatePurchaseProductInfo() {
            const select = document.getElementById('purchaseProduct');
            const selectedOption = select.options[select.selectedIndex];
            const stock = selectedOption.getAttribute('data-stock');
            
            document.getElementById('currentStock').value = stock || '0';
            calculatePurchaseTotal();
        }
        
        // Calculate sale total
        function calculateSaleTotal() {
            const select = document.getElementById('saleProduct');
            const selectedOption = select.options[select.selectedIndex];
            const price = parseFloat(selectedOption.getAttribute('data-price') || '0');
            const quantity = parseInt(document.getElementById('saleQuantity').value || '0');
            
            const total = price * quantity;
            document.getElementById('saleTotal').value = formatCurrency(total);
        }
        
        // Calculate purchase total
        function calculatePurchaseTotal() {
            const select = document.getElementById('purchaseProduct');
            const selectedOption = select.options[select.selectedIndex];
            const price = parseFloat(selectedOption.getAttribute('data-price') || '0');
            const quantity = parseInt(document.getElementById('purchaseQuantity').value || '0');
            
            const total = price * quantity;
            document.getElementById('purchaseTotal').value = formatCurrency(total);
        }
        
        // Create sale
        async function createSale() {
            const productId = document.getElementById('saleProduct').value;
            const quantity = document.getElementById('saleQuantity').value;
            const description = document.getElementById('saleDescription').value;
            
            if (!productId || !quantity) {
                showAlert('Silakan lengkapi form', 'warning');
                return;
            }
            
            try {
                showLoading();
                const response = await fetch(`/api/transactions/sale?productId=${productId}&quantity=${quantity}&description=${encodeURIComponent(description)}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('saleModal')).hide();
                    showAlert('Sale berhasil dibuat', 'success');
                    await loadInitialData();
                    document.getElementById('saleForm').reset();
                } else {
                    throw new Error('Failed to create sale');
                }
                hideLoading();
            } catch (error) {
                console.error('Error creating sale:', error);
                hideLoading();
                showAlert('Gagal membuat sale', 'danger');
            }
        }
        
        // Create purchase
        async function createPurchase() {
            const productId = document.getElementById('purchaseProduct').value;
            const quantity = document.getElementById('purchaseQuantity').value;
            const description = document.getElementById('purchaseDescription').value;
            
            if (!productId || !quantity) {
                showAlert('Silakan lengkapi form', 'warning');
                return;
            }
            
            try {
                showLoading();
                const response = await fetch(`/api/transactions/purchase?productId=${productId}&quantity=${quantity}&description=${encodeURIComponent(description)}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide();
                    showAlert('Purchase berhasil dibuat', 'success');
                    await loadInitialData();
                    document.getElementById('purchaseForm').reset();
                } else {
                    throw new Error('Failed to create purchase');
                }
                hideLoading();
            } catch (error) {
                console.error('Error creating purchase:', error);
                hideLoading();
                showAlert('Gagal membuat purchase', 'danger');
            }
        }
        
        // View transaction
        function viewTransaction(id) {
            const transaction = allTransactions.find(t => t.id === id);
            if (!transaction) return;
            
            const details = `
                <strong>ID:</strong> ${transaction.id}<br>
                <strong>Tanggal:</strong> ${formatDate(transaction.createdAt)}<br>
                <strong>Produk:</strong> ${transaction.product.name}<br>
                <strong>Tipe:</strong> ${transaction.transactionType}<br>
                <strong>Quantity:</strong> ${transaction.quantity}<br>
                <strong>Total Harga:</strong> Rp ${transaction.totalPrice.toLocaleString('id-ID')}<br>
                <strong>Deskripsi:</strong> ${transaction.description || '-'}
            `;
            
            bootbox.dialog({
                title: 'Detail Transaksi',
                message: details,
                buttons: {
                    close: {
                        label: 'Tutup',
                        className: 'btn-secondary'
                    }
                }
            });
        }
        
        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
                // Implement delete transaction
                showAlert('Fitur hapus transaksi akan segera hadir!', 'info');
            }
        }
        
        // Change view
        function changeView(view) {
            const tableView = document.getElementById('tableView');
            const chartView = document.getElementById('chartView');
            
            if (view === 'table') {
                tableView.style.display = 'block';
                chartView.style.display = 'none';
            } else if (view === 'chart') {
                tableView.style.display = 'none';
                chartView.style.display = 'block';
                initCharts();
            }
        }
        
        // Initialize charts
        function initCharts() {
            // Transaction chart
            const transactionCtx = document.getElementById('transactionChart');
            if (transactionCtx) {
                if (transactionChart) transactionChart.destroy();
                
                transactionChart = new Chart(transactionCtx, {
                    type: 'line',
                    data: {
                        labels: generateDateLabels(7),
                        datasets: [{
                            label: 'Sales',
                            data: generateRandomData(7, 1000, 5000),
                            borderColor: '#1cc88a',
                            backgroundColor: 'rgba(28, 200, 138, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Purchases',
                            data: generateRandomData(7, 500, 3000),
                            borderColor: '#36b9cc',
                            backgroundColor: 'rgba(54, 185, 204, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' }
                        }
                    }
                });
            }
            
            // Type distribution chart
            const typeCtx = document.getElementById('typeChart');
            if (typeCtx) {
                if (typeChart) typeChart.destroy();
                
                const saleCount = filteredTransactions.filter(t => t.transactionType === 'SALE').length;
                const purchaseCount = filteredTransactions.filter(t => t.transactionType === 'PURCHASE').length;
                
                typeChart = new Chart(typeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Sales', 'Purchases'],
                        datasets: [{
                            data: [saleCount, purchaseCount],
                            backgroundColor: ['#1cc88a', '#36b9cc'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        }
        
        // Utility functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(value);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function generateDateLabels(days) {
            const labels = [];
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' }));
            }
            return labels;
        }
        
        function generateRandomData(count, min, max) {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push(Math.floor(Math.random() * (max - min + 1)) + min);
            }
            return data;
        }
        
        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredTransactions.length / pageSize);
            if (page >= 0 && page < totalPages) {
                currentPage = page;
                displayTransactions();
            }
        }
        
        // Refresh table
        function refreshTable() {
            loadInitialData();
        }
        
        // Generate report
        function generateReport() {
            showAlert('Fitur laporan akan segera hadir!', 'info');
        }
        
        // Load initial data when page loads
        document.addEventListener('DOMContentLoaded', loadInitialData);
    </script>
</body>
</html>